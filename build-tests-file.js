// TODO: document the purpose of this file

const fs = require('fs');

const indentModeTests = require('./tests/indent-mode.json');
const parenModeTests = require('./tests/paren-mode.json');

const warningLine = '""!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n';
const squigglyLine = '""~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n';

var output =
  warningLine +
  warningLine +
  '""' + '\n' +
  '"" NOTE: This file is automatically generated from build-tests-file.js' + '\n' +
  '""       Please do not edit it directly' + '\n' +
  '""' + '\n' +
  warningLine +
  warningLine + '\n' +
  'source parinfer.vim' + '\n\n' +
  squigglyLine +
  '"" Indent Mode Tests' + '\n' +
  squigglyLine + '\n';

indentModeTests.forEach(function(t) {
  output += writeTestCase(t, 'indent') + '\n\n';
})

output += squigglyLine +
  '"" Paren Mode Tests' + '\n' +
  squigglyLine + '\n';

parenModeTests.forEach(function(t) {
  output += writeTestCase(t, 'paren') + '\n\n';
})

fs.writeFileSync('tests.vim', output, {encoding: 'utf8'});


// TODO: check idempotence
// TODO: check cross-mode preservation

/*
let s:testId =
let s:result = g:ParinferLib.IndentMode()
let s:expectedText =
if s:result.text !=# s:expectedText
  echom 'Test id ' . s:testId . ' failed'
endif
*/
function writeTestCase(test, mode) {
  var vimlFn = 'g:ParinferLib.IndentMode';
  var modeStr = 'Indent Mode';
  if (mode === 'paren') {
    modeStr = 'Paren Mode';
    vimlFn = 'g:ParinferLib.ParenMode';
  }

  var testId = test.in.fileLineNo;
  var inText = test.in.lines.join('\\n').replace(/'/g, "\\'");
  var expectedText = test.out.lines.join('\\n').replace(/'/g, "\\'");

  var c = '';
  c += 'let s:result = ' + vimlFn + '("' + escapeVimlString(inText) + '", {})' + '\n';
  c += 'let s:expectedText = "' + escapeVimlString(expectedText) + '"' + '\n';
  c += 'if s:result.text !=# s:expectedText' + '\n';
  c += '    echom "' + modeStr + ' Test ' + testId + ' failed"' + '\n';
  c += 'endif' + '\n';

  return c;
}

function escapeVimlString(s) {
  s = s.replace(/\"/g, '\\"');
  return s;
}
