// This file builds "tests.vim", which runs the Parinfer tests using Vimscript.

const fs = require('fs');
const indentModeTests = require('./tests/indent-mode.json');
const parenModeTests = require('./tests/paren-mode.json');
const nl = '\n';
const nl2 = nl + nl;
const warningLine = '""!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!' + nl;
const squigglyLine = '""~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~' + nl;
const testFile = 'tests.vim';

var output =
  warningLine +
  warningLine +
  '""' + nl +
  '"" NOTE: This file is automatically generated from build-tests-file.js' + nl +
  '""       Please do not edit it directly' + nl +
  '""' + nl +
  warningLine +
  warningLine + nl +
  'source parinfer.vim' + nl +
  'let s:anyErrorsFound = 0' + nl2 +
  squigglyLine +
  '"" Indent Mode Tests' + nl +
  squigglyLine + nl;

indentModeTests.forEach(function(test) {
  output += writeTestCase(test, 'indent') + nl2;
});

output += squigglyLine +
  '"" Paren Mode Tests' + nl +
  squigglyLine + nl;

parenModeTests.forEach(function(test) {
  output += writeTestCase(test, 'paren') + nl2;
});

output += squigglyLine +
  '"" Show success if there were no failures' + nl +
  squigglyLine +
  'if ! s:anyErrorsFound' + nl +
  '    silent !echo "All tests passed"' + nl +
  '    q' + nl +
  'else' + nl +
  '    cq' + nl +
  'endif' + nl;

fs.writeFileSync(testFile, output, {encoding: 'utf8'});

//------------------------------------------------------------------------------
// Functions
//------------------------------------------------------------------------------

function writeTestCase(test, mode) {
  const indentModeFn = 'g:ParinferLib.IndentMode';
  const parenModeFn = 'g:ParinferLib.ParenMode';

  var mainFn = indentModeFn;
  var oppositeFn = parenModeFn;
  var modeStr = 'Indent Mode';

  if (mode === 'paren') {
    mainFn = parenModeFn;
    oppositeFn = indentModeFn;
    modeStr = 'Paren Mode';
  }

  const testId = test.in.fileLineNo;
  const inText = test.in.lines.join(nl);
  const expectedText = test.out.lines.join(nl);
  const options = buildOptions(test.in.cursor);

  var c = '';
  c += '"" Test Id: ' + testId + nl;
  c += 'let s:result = ' + mainFn + '(' + escapeVimlString(inText) + ', ' + options + ')' + nl;
  c += 'let s:expectedText = ' + escapeVimlString(expectedText) + nl;
  c += 'let s:outText = s:result.text' + nl;
  c += 'let s:result2 = ' + mainFn + '(s:outText, ' + options + ')' + nl;
  c += 'let s:outText2 = s:result2.text' + nl;
  c += 'if s:outText !=# s:expectedText' + nl;
  c += '    let s:anyErrorsFound = 1' + nl;
  c += '    silent !echo "' + modeStr + ' In/Out test ' + testId + ' failed"' + nl;
  c += 'endif' + nl;
  c += 'if s:outText2 !=# s:expectedText' + nl;
  c += '    let s:anyErrorsFound = 1' + nl;
  c += '    silent !echo "' + modeStr + ' Idempotence test ' + testId + ' failed"' + nl;
  c += 'endif' + nl;

  // test cross-mode preservation if there are no options
  if (options === '{}') {
    c += 'let s:result3 = ' + oppositeFn + '(s:outText, ' + options + ')' + nl;
    c += 'let s:outText3 = s:result3.text' + nl;
    c += 'if s:outText3 !=# s:expectedText' + nl;
    c += '    let s:anyErrorsFound = 1' + nl;
    c += '    silent !echo "' + modeStr + ' Cross-mode preservation test ' + testId + ' failed"' + nl;
    c += 'endif' + nl;
  }

  return c;
}

function buildOptions(opts) {
  var optionsStr = '{';
  if (opts) {
    if (opts.hasOwnProperty('cursorX'))    { optionsStr += "'cursorX':" + opts.cursorX + ','; }
    if (opts.hasOwnProperty('cursorLine')) { optionsStr += "'cursorLine':" + opts.cursorLine + ','; }
    if (opts.hasOwnProperty('cursorDx'))   { optionsStr += "'cursorDx':" + opts.cursorDx + ','; }
  }
  optionsStr += '}';

  return optionsStr
}

function escapeVimlString(s) {
  return JSON.stringify(s);
}
